<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –Ω–æ–º–µ—Ä—ñ–≤</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #faf8ff;
  --bg2:     #f0ebff;
  --bg3:     #e4dbf7;
  --ink:     #3d2278;
  --ink2:    #5b3fa0;
  --muted:   #9585b8;
  --accent:  #d63b4a;
  --accent2: #1a7a46;
  --accent3: #7c3aed;
  --warn:    #c07000;
  --border:  #d5c8f0;
  --white:   #ffffff;

  --dbg-bg:   #f5f2ff;
  --dbg-line: #ede8ff;
  --dbg-ok:   #166534;
  --dbg-err:  #991b1b;
  --dbg-warn: #92400e;
  --dbg-inf:  #3730a3;
  --dbg-muted:#7c6fa0;
}

body {
  font-family: 'IBM Plex Mono', monospace;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  padding: 36px 20px 80px;
}

.wrap { max-width: 1080px; margin: 0 auto; }

header {
  margin-bottom: 40px; padding-bottom: 24px;
  border-bottom: 2px solid var(--border);
  display: flex; align-items: flex-end; justify-content: space-between;
  gap: 20px; flex-wrap: wrap;
}
header h1 {
  font-family: 'Syne', sans-serif;
  font-size: clamp(24px, 4.5vw, 46px);
  font-weight: 800; letter-spacing: -2px; line-height: 1;
  color: var(--ink);
}
header h1 em { font-style: normal; color: var(--accent3); }
.header-sub { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; padding-bottom: 4px; }

.block {
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 24px 26px;
  margin-bottom: 16px;
  box-shadow: 0 2px 12px rgba(92,46,178,0.07), 4px 4px 0 var(--bg3);
  animation: fadeUp 0.3s ease both;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.block-title {
  font-family: 'Syne', sans-serif;
  font-size: 10px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.block-title::after { content:''; flex:1; height:1px; background:var(--border); }

textarea {
  width: 100%; height: 160px;
  background: var(--bg); border: 1.5px solid var(--border); border-radius: 6px;
  font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--ink);
  padding: 12px 14px; resize: vertical; outline: none;
  transition: border-color 0.2s; line-height: 1.6;
}
textarea:focus { border-color: var(--accent3); box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
textarea::placeholder { color: var(--muted); }

.dropzone {
  position: relative; border: 2px dashed var(--border); border-radius: 6px;
  padding: 16px; text-align: center; margin-top: 12px; cursor: pointer;
  transition: all 0.2s; background: var(--bg); color: var(--muted); font-size: 12px;
}
.dropzone:hover, .dropzone.drag { border-color: var(--accent3); background: var(--bg2); color: var(--ink2); }
.dropzone input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
.dropzone-icon { font-size: 20px; display: block; margin-bottom: 4px; }
#file-name { margin-top:8px; font-size:12px; color:var(--accent2); font-weight:600; min-height:16px; }

/* no-header banner */
.no-header-banner {
  display: none;
  background: rgba(192,112,0,0.08);
  border: 1.5px solid rgba(192,112,0,0.35);
  border-radius: 6px;
  padding: 10px 16px;
  font-size: 12px;
  color: var(--warn);
  margin-bottom: 16px;
  line-height: 1.6;
}
.no-header-banner.visible { display: block; }

.mapping-hint {
  font-size: 13px; color: var(--ink2); margin-bottom: 18px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 6px; padding: 12px 16px; line-height: 1.6;
}
.mapping-hint strong { color: var(--accent3); }
.mapping-hint code { background:var(--bg3); padding:1px 5px; border-radius:3px; font-size:11px; color:var(--ink); }

.preview-wrap { margin-bottom: 20px; overflow-x: auto; }
.preview-wrap::-webkit-scrollbar { height: 5px; }
.preview-wrap::-webkit-scrollbar-track { background: var(--bg); }
.preview-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.preview-table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 500px; }
.preview-table th {
  background: var(--bg2); border: 1px solid var(--border);
  padding: 6px 10px; text-align: left; color: var(--muted);
  font-size: 10px; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;
}
.preview-table td { border: 1px solid var(--border); padding: 6px 10px; color: var(--ink); max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.preview-table tr:nth-child(even) td { background: var(--bg); }
.preview-table th.is-key-th { background: var(--bg2); border-top: 3px solid var(--accent3); color: var(--accent3); }
.preview-table td.is-key-td { background: rgba(124,58,237,0.05); font-weight: 600; color: var(--accent3); }

.col-select-list { display: flex; flex-direction: column; gap: 8px; }

.col-select-item {
  display: grid; grid-template-columns: auto 1fr auto;
  align-items: center; gap: 12px;
  background: var(--bg); border: 1.5px solid var(--border);
  border-radius: 6px; padding: 10px 14px; cursor: pointer; transition: all 0.15s; position: relative;
}
.col-select-item:hover { border-color: var(--accent3); background: var(--bg2); }
.col-select-item.is-key { border-color: var(--accent3); background: linear-gradient(135deg, rgba(124,58,237,0.05) 0%, var(--white) 100%); box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
.col-radio { display: none; }
.col-radio-visual { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--border); background: var(--white); flex-shrink: 0; transition: all 0.15s; display: flex; align-items: center; justify-content: center; }
.col-select-item.is-key .col-radio-visual { border-color: var(--accent3); background: var(--accent3); }
.col-radio-visual::after { content: ''; width: 6px; height: 6px; border-radius: 50%; background: white; opacity: 0; transition: opacity 0.15s; }
.col-select-item.is-key .col-radio-visual::after { opacity: 1; }
.col-info { min-width: 0; }
.col-label-row { display: flex; align-items: center; gap: 8px; margin-bottom: 3px; }
.col-num-badge { font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); background: var(--bg3); padding: 1px 6px; border-radius: 10px; flex-shrink: 0; }
.col-alias-input { font-family: 'IBM Plex Mono', monospace; font-size: 12px; font-weight: 600; color: var(--ink); background: transparent; border: none; outline: none; border-bottom: 1.5px dashed var(--border); padding: 0 2px; width: 100%; min-width: 80px; transition: border-color 0.2s; }
.col-alias-input:focus { border-bottom-color: var(--accent3); }
.col-sample { font-size: 10px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
.col-sample span { color: var(--ink2); }
.col-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; flex-shrink: 0; }
.key-badge-v2 { display: none; font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--accent3); background: rgba(124,58,237,0.1); padding: 2px 8px; border-radius: 20px; border: 1px solid rgba(124,58,237,0.25); }
.col-select-item.is-key .key-badge-v2 { display: inline-flex; }
.vis-toggle { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--muted); cursor: pointer; user-select: none; }
.vis-toggle input[type=checkbox] { accent-color: var(--accent3); cursor: pointer; width: 13px; height: 13px; }
.auto-hint { display: inline-flex; align-items: center; gap: 5px; font-size: 10px; color: var(--accent3); font-weight: 600; background: rgba(124,58,237,0.08); padding: 2px 8px; border-radius: 20px; margin-left: 8px; }

.btn-row { display:flex; gap:10px; flex-wrap:wrap; }
.btn { font-family:'IBM Plex Mono',monospace; font-size:12px; font-weight:600; letter-spacing:0.3px; padding:10px 18px; border:1.5px solid transparent; border-radius:6px; cursor:pointer; transition:all 0.15s; display:inline-flex; align-items:center; gap:7px; white-space:nowrap; }
.btn:disabled { opacity:0.3; cursor:not-allowed !important; transform:none !important; box-shadow:none !important; }
.btn-primary { background:var(--accent3); color:#fff; border-color:var(--accent3); box-shadow:0 2px 8px rgba(124,58,237,0.3); }
.btn-primary:not(:disabled):hover { background:var(--ink2); border-color:var(--ink2); transform:translateY(-1px); box-shadow:0 4px 12px rgba(124,58,237,0.35); }
.btn-danger  { background:var(--white); color:var(--accent);  border-color:var(--accent);  box-shadow:3px 3px 0 rgba(214,59,74,0.12); }
.btn-danger:not(:disabled):hover  { background:var(--accent);  color:#fff; transform:translate(-1px,-1px); }
.btn-success { background:var(--white); color:var(--accent2); border-color:var(--accent2); box-shadow:3px 3px 0 rgba(26,122,70,0.12); }
.btn-success:not(:disabled):hover { background:var(--accent2); color:#fff; transform:translate(-1px,-1px); }
.btn-warn    { background:var(--white); color:var(--warn);    border-color:var(--warn);    box-shadow:3px 3px 0 rgba(192,112,0,0.12); }
.btn-warn:not(:disabled):hover    { background:var(--warn);    color:#fff; transform:translate(-1px,-1px); }

.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; margin-bottom:16px; }
.stat-card { border:1.5px solid var(--border); border-radius:8px; padding:16px 18px; background:var(--bg); position:relative; overflow:hidden; }
.stat-card::before { content:''; position:absolute; left:0;top:0;bottom:0; width:3px; border-radius:3px 0 0 3px; }
.stat-card.c-total::before  { background:var(--accent3); }
.stat-card.c-unique::before { background:var(--accent2); }
.stat-card.c-dup::before    { background:var(--accent); }
.stat-card.c-rows::before   { background:#c07a1a; }
.stat-card.c-invalid::before{ background:var(--warn); }
.stat-num { font-family:'Syne',sans-serif; font-size:32px; font-weight:800; line-height:1; margin-bottom:4px; }
.stat-card.c-total   .stat-num { color:var(--accent3); }
.stat-card.c-unique  .stat-num { color:var(--accent2); }
.stat-card.c-dup     .stat-num { color:var(--accent); }
.stat-card.c-rows    .stat-num { color:#c07a1a; }
.stat-card.c-invalid .stat-num { color:var(--warn); }
.stat-lbl { font-size:10px; text-transform:uppercase; letter-spacing:1.5px; color:var(--muted); line-height:1.4; }

.tabs { display:flex; gap:0; border-bottom:1.5px solid var(--border); margin-bottom:18px; }
.tab-btn { font-family:'IBM Plex Mono',monospace; font-size:12px; font-weight:600; padding:8px 16px; border:none; background:none; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1.5px; transition:all 0.15s; display:flex; align-items:center; gap:6px; }
.tab-btn:hover { color:var(--ink); }
.tab-btn.active { color:var(--accent3); border-bottom-color:var(--accent3); }
.tab-btn.tab-warn.active { color:var(--warn); border-bottom-color:var(--warn); }
.tab-cnt { font-size:10px; font-weight:700; padding:1px 7px; border-radius:20px; background:var(--bg3); color:var(--muted); }
.tab-btn.active .tab-cnt { background:var(--accent3); color:#fff; }
.tab-btn.tab-warn.active .tab-cnt { background:var(--warn); color:#fff; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

.search-row { display:flex; align-items:center; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
.search-input { flex:1; min-width:180px; max-width:320px; padding:8px 13px; font-family:'IBM Plex Mono',monospace; font-size:12px; border:1.5px solid var(--border); border-radius:6px; background:var(--bg); color:var(--ink); outline:none; transition:border-color 0.2s; }
.search-input:focus { border-color:var(--accent3); box-shadow:0 0 0 3px rgba(124,58,237,0.1); }
.search-input::placeholder { color:var(--muted); }
.count-badge { font-size:11px; color:var(--muted); }

.dup-list { display:flex; flex-direction:column; gap:7px; max-height:500px; overflow-y:auto; padding-right:4px; }
.dup-list::-webkit-scrollbar { width:5px; }
.dup-list::-webkit-scrollbar-track { background:var(--bg); }
.dup-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.dup-group { border:1.5px solid var(--border); border-radius:6px; overflow:hidden; animation:fadeUp 0.2s ease both; }
.dup-header { display:flex; align-items:center; justify-content:space-between; padding:10px 15px; background:var(--bg2); cursor:pointer; transition:background 0.15s; user-select:none; border-bottom:1.5px solid transparent; }
.dup-header:hover { background:var(--bg3); }
.dup-header.open { border-bottom-color:var(--border); }
.dup-num-label { font-weight:700; font-size:13px; color:var(--accent); }
.dup-meta { display:flex; align-items:center; gap:8px; }
.pill { font-size:10px; font-weight:700; padding:2px 8px; border-radius:20px; background:var(--accent); color:#fff; }
.chevron { transition:transform 0.2s; font-size:11px; color:var(--muted); }
.chevron.r { transform:rotate(180deg); }
.dup-body { display:none; padding:10px 14px; background:var(--white); }
.dup-body.open { display:block; }
.dup-row-item { display:grid; grid-template-columns:50px 1fr; gap:10px; padding:7px 0; border-bottom:1px solid var(--bg2); font-size:11px; align-items:start; }
.dup-row-item:last-child { border-bottom:none; }
.dup-row-idx { color:var(--muted); font-size:10px; padding-top:2px; }
.dup-cols { display:flex; flex-wrap:wrap; gap:6px 14px; }
.dup-col-cell { display:flex; flex-direction:column; gap:1px; }
.dup-col-name { font-size:9px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
.dup-col-val { font-size:12px; color:var(--ink); font-weight:500; }

.invalid-list-wrap { max-height:480px; overflow-y:auto; }
.invalid-list-wrap::-webkit-scrollbar { width:5px; }
.invalid-list-wrap::-webkit-scrollbar-track { background:var(--bg); }
.invalid-list-wrap::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.invalid-table { width:100%; border-collapse:collapse; font-size:12px; }
.invalid-table th { text-align:left; padding:8px 12px; background:var(--bg2); border:1px solid var(--border); font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); font-weight:600; }
.invalid-table td { padding:8px 12px; border:1px solid var(--border); color:var(--ink); vertical-align:top; }
.invalid-table tr:nth-child(even) td { background:var(--bg); }
.invalid-table tr:hover td { background:rgba(124,58,237,0.03); }
.invalid-val { font-weight:700; color:var(--warn); }
.inv-reason { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:600; letter-spacing:0.5px; padding:2px 8px; border-radius:20px; }
.inv-reason.r-chars { background:rgba(214,59,74,0.1); color:var(--accent); }
.inv-reason.r-short { background:rgba(192,112,0,0.1); color:var(--warn); }
.inv-reason.r-long  { background:rgba(124,58,237,0.1); color:var(--accent3); }

.empty { text-align:center; padding:44px 20px; color:var(--muted); }
.empty-icon { font-size:40px; display:block; margin-bottom:10px; }
.empty-text { font-size:13px; }

#results-block { display:none; }

/* DEBUG */
#debug-panel { background: var(--dbg-bg); border: 1.5px solid var(--border); border-radius: 8px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(92,46,178,0.08); font-family: 'IBM Plex Mono', monospace; }
.dbg-header { display: flex; align-items: center; justify-content: space-between; padding: 11px 18px; background: var(--bg2); border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
.dbg-header:hover { background: var(--bg3); }
.dbg-title { display:flex; align-items:center; gap:10px; font-size:12px; font-weight:600; color:var(--ink2); letter-spacing:1px; text-transform:uppercase; }
.dbg-dot { width:8px; height:8px; border-radius:50%; background:var(--dbg-ok); box-shadow:0 0 6px var(--dbg-ok); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
.dbg-dot.err { background:var(--dbg-err); box-shadow:0 0 6px var(--dbg-err); }
.dbg-controls { display:flex; align-items:center; gap:8px; }
.dbg-cnt { font-size:11px; color:var(--muted); background:var(--bg3); padding:2px 8px; border-radius:20px; }
.dbg-cnt.has-err { color:var(--dbg-err); background:rgba(153,27,27,0.08); }
.dbg-body { display:none; height:260px; overflow-y:auto; padding:8px 0; }
.dbg-body.open { display:block; }
.dbg-body::-webkit-scrollbar { width:5px; }
.dbg-body::-webkit-scrollbar-track { background:var(--bg2); }
.dbg-body::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.dbg-line { display:grid; grid-template-columns:95px 52px 1fr; padding:3px 18px; font-size:11px; line-height:1.6; border-bottom:1px solid transparent; transition:background 0.1s; }
.dbg-line:hover { background:var(--dbg-line); }
.dbg-ts { color:var(--muted); }
.dbg-lvl { font-weight:700; font-size:10px; letter-spacing:0.5px; }
.dbg-msg { color:var(--ink); word-break:break-all; }
.lvl-ok   { color:var(--dbg-ok); }
.lvl-err  { color:var(--dbg-err); }
.lvl-warn { color:var(--dbg-warn); }
.lvl-info { color:var(--dbg-inf); }
.dbg-line.level-err  { background:rgba(248,113,113,0.06); }
.dbg-line.level-warn { background:rgba(251,191,36,0.04); }
.dbg-footer { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:9px 18px; background:var(--bg2); border-top:1px solid var(--border); flex-wrap:wrap; }
.dbg-filter { display:flex; gap:5px; flex-wrap:wrap; }
.dbg-filter-btn { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:600; letter-spacing:0.5px; padding:3px 10px; border-radius:20px; border:1px solid var(--border); background:var(--white); color:var(--muted); cursor:pointer; transition:all 0.15s; }
.dbg-filter-btn:hover { border-color:var(--dbg-inf); color:var(--dbg-inf); }
.dbg-filter-btn.active { background:rgba(55,48,163,0.08); border-color:var(--dbg-inf); color:var(--dbg-inf); }
.dbg-filter-btn.f-ok.active   { background:rgba(22,101,52,0.08);  border-color:var(--dbg-ok);   color:var(--dbg-ok); }
.dbg-filter-btn.f-err.active  { background:rgba(153,27,27,0.08);  border-color:var(--dbg-err);  color:var(--dbg-err); }
.dbg-filter-btn.f-warn.active { background:rgba(146,64,14,0.08);  border-color:var(--dbg-warn); color:var(--dbg-warn); }
.dbg-dl-btn { font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:600; padding:4px 12px; background:var(--white); color:var(--ink2); border:1px solid var(--border); border-radius:4px; cursor:pointer; transition:all 0.15s; display:flex; align-items:center; gap:6px; }
.dbg-dl-btn:hover { background:var(--bg2); border-color:var(--dbg-ok); color:var(--dbg-ok); }
.dbg-clear-btn { font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:600; padding:4px 10px; background:transparent; color:var(--muted); border:1px solid var(--border); border-radius:4px; cursor:pointer; transition:all 0.15s; }
.dbg-clear-btn:hover { border-color:var(--dbg-err); color:var(--dbg-err); }
</style>
</head>
<body>
<div class="wrap">

<header>
  <div><h1>–î–£–ë–õ–Ü<em>.</em>CSV</h1></div>
  <div class="header-sub">–ê–Ω–∞–ª—ñ–∑ ¬∑ –í–∞–ª—ñ–¥–∞—Ü—ñ—è ¬∑ –û—á–∏—â–µ–Ω–Ω—è</div>
</header>

<!-- DEBUG -->
<div id="debug-panel">
  <div class="dbg-header" onclick="toggleDbg()">
    <div class="dbg-title">
      <span class="dbg-dot" id="dbg-dot"></span>
      üêõ Debug Log
    </div>
    <div class="dbg-controls">
      <span class="dbg-cnt" id="dbg-cnt">0 –ø–æ–¥—ñ–π</span>
      <span style="font-size:11px;color:#6b5d8a" id="dbg-chevron">‚ñº</span>
    </div>
  </div>
  <div class="dbg-body" id="dbg-body"></div>
  <div class="dbg-footer">
    <div class="dbg-filter">
      <button class="dbg-filter-btn active" id="ff-all"  onclick="dbgFilter('all')">–í—Å—ñ</button>
      <button class="dbg-filter-btn f-ok"   id="ff-ok"   onclick="dbgFilter('ok')">‚úì –£—Å–ø—ñ—Ö</button>
      <button class="dbg-filter-btn f-err"  id="ff-err"  onclick="dbgFilter('err')">‚úï –ü–æ–º–∏–ª–∫–∏</button>
      <button class="dbg-filter-btn f-warn" id="ff-warn" onclick="dbgFilter('warn')">‚ö† –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è</button>
      <button class="dbg-filter-btn"        id="ff-info" onclick="dbgFilter('info')">‚Ñπ –Ü–Ω—Ñ–æ</button>
    </div>
    <div style="display:flex;gap:6px;">
      <button class="dbg-clear-btn" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      <button class="dbg-dl-btn"    onclick="downloadLog()">‚¨á –ó–±–µ—Ä–µ–≥—Ç–∏ .log</button>
    </div>
  </div>
</div>

<!-- 1. –î–∞–Ω—ñ -->
<div class="block">
  <div class="block-title">üìÇ –î–∞–Ω—ñ</div>
  <textarea id="textarea" placeholder="–í—Å—Ç–∞–≤—Ç–µ CSV / TSV / Tab-–¥–∞–Ω—ñ —Å—é–¥–∏ (Ctrl+V)‚Ä¶"></textarea>
  <div class="dropzone" id="dropzone">
    <input type="file" id="file-input" accept=".csv,.tsv,.txt">
    <span class="dropzone-icon">üìÑ</span>
    –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É (.csv / .tsv / .txt)
  </div>
  <div id="file-name"></div>
</div>

<!-- 2. –í–∏–±—ñ—Ä –∫–æ–ª–æ–Ω–∫–∏ -->
<div class="block" id="mapping-block" style="display:none;">
  <div class="block-title">üóÇ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫</div>

  <!-- –ë–∞–Ω–µ—Ä: –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
  <div class="no-header-banner" id="no-header-banner">
    ‚ö†Ô∏è <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ.</strong> –ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ —Å—Ö–æ–∂–∏–π –Ω–∞ –¥–∞–Ω—ñ, —Ç–æ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞–Ω–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ <code>–ö–æ–ª–æ–Ω–∫–∞ 1‚Ä¶N</code>. –í—Å—ñ —Ä—è–¥–∫–∏ –≤–∫–ª—é—á–µ–Ω—ñ –≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É.
  </div>

  <div class="mapping-hint">
    üëá <strong>–í–∫–∞–∂—ñ—Ç—å –∫–æ–ª–æ–Ω–∫—É –∑ –Ω–æ–º–µ—Ä–∞–º–∏ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</strong> ‚Äî –∫–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π —Ä—è–¥–æ–∫.<br>
    –ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ –∫–æ–ª–æ–Ω–∫–∏ —Ç–∞ –≤–∏–º–∫–Ω—É—Ç–∏ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑—ñ –∑–≤—ñ—Ç—É.
  </div>

  <div class="preview-wrap" id="preview-wrap"></div>
  <div class="col-select-list" id="col-select-list"></div>
</div>

<!-- 3. –î—ñ—ó -->
<div class="block">
  <div class="block-title">‚öôÔ∏è –î—ñ—ó</div>
  <div class="btn-row">
    <button class="btn btn-primary" onclick="runCheck()">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ</button>
    <button class="btn btn-danger"  id="btn-dl-dup"   onclick="downloadDuplicates()"       disabled>üì• –î—É–±–ª—ñ (CSV)</button>
    <button class="btn btn-success" id="btn-dl-clean" onclick="downloadWithoutDuplicates()" disabled>‚ú® –ë–µ–∑ –¥—É–±–ª—ñ–≤ (CSV)</button>
    <button class="btn btn-warn"    id="btn-dl-inv"   onclick="downloadInvalid()"           disabled>‚ö†Ô∏è –ù–µ–≤–∞–ª—ñ–¥–Ω—ñ (CSV)</button>
  </div>
</div>

<!-- 4. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ -->
<div id="results-block">
  <div class="block">
    <div class="block-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    <div class="stats-grid">
      <div class="stat-card c-total">  <div class="stat-num" id="s-total">0</div>  <div class="stat-lbl">–í—Å—å–æ–≥–æ —Ä—è–¥–∫—ñ–≤</div></div>
      <div class="stat-card c-unique"> <div class="stat-num" id="s-unique">0</div> <div class="stat-lbl">–£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö ‚Ññ</div></div>
      <div class="stat-card c-dup">    <div class="stat-num" id="s-dup">0</div>    <div class="stat-lbl">‚Ññ –∑ –¥—É–±–ª—è–º–∏</div></div>
      <div class="stat-card c-rows">   <div class="stat-num" id="s-rows">0</div>   <div class="stat-lbl">–†—è–¥–∫—ñ–≤-–¥—É–±–ª—ñ–≤</div></div>
      <div class="stat-card c-invalid"><div class="stat-num" id="s-invalid">0</div><div class="stat-lbl">–ù–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö ‚Ññ</div></div>
    </div>
  </div>

  <div class="block">
    <div class="tabs">
      <button class="tab-btn active"   id="tab-dup-btn" onclick="switchTab('dup')">
        üîÅ –î—É–±–ª—ñ <span class="tab-cnt" id="tc-dup">0</span>
      </button>
      <button class="tab-btn tab-warn" id="tab-inv-btn" onclick="switchTab('inv')">
        ‚ö†Ô∏è –ù–µ–≤–∞–ª—ñ–¥–Ω—ñ –Ω–æ–º–µ—Ä–∏ <span class="tab-cnt" id="tc-inv">0</span>
      </button>
    </div>
    <div class="tab-panel active" id="tab-dup">
      <div class="search-row">
        <input class="search-input" id="search-input" placeholder="üîé –ü–æ—à—É–∫ –∑–∞ –Ω–æ–º–µ—Ä–æ–º‚Ä¶" oninput="filterDups()" disabled>
        <span class="count-badge" id="search-count"></span>
      </div>
      <div class="dup-list" id="dup-list"></div>
    </div>
    <div class="tab-panel" id="tab-inv">
      <div class="search-row">
        <input class="search-input" id="inv-search" placeholder="üîé –ü–æ—à—É–∫‚Ä¶" oninput="filterInvalid()">
        <span class="count-badge" id="inv-count"></span>
      </div>
      <div class="invalid-list-wrap">
        <table class="invalid-table">
          <thead id="inv-thead"></thead>
          <tbody id="inv-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEBUG LOGGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LOG = [];
let dbgOpen = false, dbgFilter_ = 'all', dbgHasErr = false;

function ts() {
  const n = new Date();
  return `${pad(n.getHours())}:${pad(n.getMinutes())}:${pad(n.getSeconds())}.${pad3(n.getMilliseconds())}`;
}
const pad  = n => String(n).padStart(2,'0');
const pad3 = n => String(n).padStart(3,'0');

function log(level, msg, data) {
  const entry = { ts: ts(), level, msg, data, date: new Date().toISOString() };
  LOG.push(entry);
  if (level === 'err') dbgHasErr = true;
  updateDbgHeader();
  if (dbgOpen) appendLine(entry);
  const fn = level==='err'?'error':level==='warn'?'warn':'log';
  console[fn](`[${entry.ts}][${level.toUpperCase()}] ${msg}`, data??'');
}
const logOk   = (m,d) => log('ok',m,d);
const logErr  = (m,d) => log('err',m,d);
const logWarn = (m,d) => log('warn',m,d);
const logInfo = (m,d) => log('info',m,d);

function updateDbgHeader() {
  const errCnt = LOG.filter(e=>e.level==='err').length;
  const cnt = document.getElementById('dbg-cnt');
  cnt.textContent = `${LOG.length} –ø–æ–¥—ñ–π${errCnt?' ¬∑ '+errCnt+' –ø–æ–º–∏–ª–æ–∫':''}`;
  cnt.className = 'dbg-cnt'+(errCnt?' has-err':'');
  document.getElementById('dbg-dot').className = 'dbg-dot'+(errCnt?' err':'');
}

function appendLine(entry) {
  if (dbgFilter_!=='all' && entry.level!==dbgFilter_) return;
  const body = document.getElementById('dbg-body');
  const d = document.createElement('div');
  d.className = `dbg-line level-${entry.level}`;
  const lm = {ok:'‚úì OK',err:'‚úï ERR',warn:'‚ö† WARN',info:'‚Ñπ INFO'};
  const dataStr = entry.data!==undefined ? ` <span style="opacity:0.45">‚Üí ${esc(JSON.stringify(entry.data))}</span>` : '';
  d.innerHTML = `<span class="dbg-ts">${entry.ts}</span><span class="dbg-lvl lvl-${entry.level}">${lm[entry.level]||entry.level}</span><span class="dbg-msg">${esc(entry.msg)}${dataStr}</span>`;
  body.appendChild(d);
  body.scrollTop = body.scrollHeight;
}

function redrawLog() {
  const body = document.getElementById('dbg-body');
  body.innerHTML = '';
  LOG.forEach(e => { if (dbgFilter_==='all'||e.level===dbgFilter_) appendLine(e); });
}

function toggleDbg() {
  dbgOpen = !dbgOpen;
  document.getElementById('dbg-body').classList.toggle('open', dbgOpen);
  document.getElementById('dbg-chevron').textContent = dbgOpen?'‚ñ≤':'‚ñº';
  if (dbgOpen) redrawLog();
}

function dbgFilter(f) {
  dbgFilter_ = f;
  document.querySelectorAll('.dbg-filter-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`ff-${f}`).classList.add('active');
  if (dbgOpen) redrawLog();
}

function clearLog() {
  LOG.length = 0; dbgHasErr = false;
  document.getElementById('dbg-body').innerHTML = '';
  updateDbgHeader(); logInfo('–õ–æ–≥ –æ—á–∏—â–µ–Ω–æ –≤—Ä—É—á–Ω—É');
}

function downloadLog() {
  const lines = LOG.map(e=>`[${e.date}] [${e.level.toUpperCase().padEnd(4)}] ${e.msg}${e.data!==undefined?' | '+JSON.stringify(e.data):''}`);
  const head = ['='.repeat(70),'DUPLICATE CHECKER ‚Äî DEBUG LOG',`–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('uk-UA')}`,`–ü–æ–¥—ñ–π: ${LOG.length} | –ü–æ–º–∏–ª–æ–∫: ${LOG.filter(e=>e.level==='err').length}`,'='.repeat(70),''].join('\n');
  const blob = new Blob([head+lines.join('\n')],{type:'text/plain;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `debug_${new Date().toISOString().replace(/[:.]/g,'-').slice(0,19)}.log`;
  a.click();
  logOk('–õ–æ–≥ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É —Ñ–∞–π–ª');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  rows:[], headers:[], sep:'\t',
  colMap:[],
  syntheticHeader: false,   // ‚Üê NEW: —á–∏ –±—É–≤ –¥–æ–¥–∞–Ω–∏–π —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
  groups:{}, order:[], dupOrder:[], invalid:[], keyCol:0,
};

const NUM_MIN=10, NUM_MAX=15;
const REASONS = {
  chars:{ cls:'r-chars', text:'‚õî –ù–µ—á–∏—Å–ª–æ–≤—ñ —Å–∏–º–≤–æ–ª–∏' },
  short:{ cls:'r-short', text:'üìè –ú–µ–Ω—à–µ 10 —Ü–∏—Ñ—Ä' },
  long: { cls:'r-long',  text:'üìè –ë—ñ–ª—å—à–µ 15 —Ü–∏—Ñ—Ä' },
};
const PREVIEW_ROWS = 5;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detectSep(line) {
  if (line.includes('\t')) return '\t';
  const s=(line.match(/;/g)||[]).length, c=(line.match(/,/g)||[]).length;
  return s>=c?';':',';
}

function parseLine(line, sep) {
  if (sep!==',') return line.split(sep).map(c=>c.trim().replace(/^"|"$/g,''));
  const res=[]; let cur='',inQ=false;
  for (let i=0;i<line.length;i++){
    const ch=line[i];
    if (ch==='"'){inQ=!inQ;continue;}
    if (ch===','&&!inQ){res.push(cur.trim());cur='';continue;}
    cur+=ch;
  }
  res.push(cur.trim()); return res;
}

function norm(v){ return String(v??'').replace(/^'+/,'').trim(); }

/**
 * –í–∏–∑–Ω–∞—á–∞—î, —á–∏ —Å—Ö–æ–∂–∏–π —Ä—è–¥–æ–∫ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–∞ –Ω–µ –Ω–∞ –¥–∞–Ω—ñ).
 * –Ø–∫—â–æ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ ‚Äî —Ü–µ —á–∏—Å–ª–æ–≤—ñ –Ω–æ–º–µ—Ä–∏, —Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ–º–∞—î.
 */
function looksLikeHeader(cells) {
  // –Ø–∫—â–æ —Ö–æ—á–∞ –± –æ–¥–Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ ‚Äî –≤–∏–∫–ª—é—á–Ω–æ —Ü–∏—Ñ—Ä–∏ –¥–æ–≤–∂–∏–Ω–æ—é 8+, —Ü–µ –¥–∞–Ω—ñ, –∞ –Ω–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const dataLikeCells = cells.filter(c => /^\d{8,}$/.test(norm(c)));
  return dataLikeCells.length === 0;
}

function loadText(text) {
  try {
    const lines = text.trim().split(/\r?\n/).filter(l=>l.trim());
    if (lines.length<1){ logWarn('loadText: –ø–æ—Ä–æ–∂–Ω—ñ–π —Ñ–∞–π–ª'); return; }
    S.sep = detectSep(lines[0]);
    const parsed = lines.map(l=>parseLine(l,S.sep));

    // ‚îÄ‚îÄ –ö–õ–Æ–ß–û–í–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ ‚Äî —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    if (looksLikeHeader(parsed[0])) {
      // –Ñ –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞
      S.headers = parsed[0];
      S.rows = parsed;
      S.syntheticHeader = false;
    } else {
      // –ó–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ–º–∞—î ‚Äî –≥–µ–Ω–µ—Ä—É—î–º–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω–∏–π —ñ –≤—Å—Ç–∞–≤–ª—è—î–º–æ –ø–µ—Ä—à–∏–º
      const colCount = parsed[0].length;
      S.headers = Array.from({length: colCount}, (_, i) => `–ö–æ–ª–æ–Ω–∫–∞ ${i+1}`);
      S.rows = [S.headers, ...parsed];   // synthetic header + –≤—Å—ñ —Ä—è–¥–∫–∏ —è–∫ –¥–∞–Ω—ñ
      S.syntheticHeader = true;
      logWarn('–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ ‚Äî –¥–æ–¥–∞–Ω–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω–∏–π', { synthHeaders: S.headers });
    }
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    logInfo('–î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ',{ rows: S.rows.length-1, cols:S.headers.length, sep:S.sep==='\t'?'TAB':S.sep, syntheticHeader: S.syntheticHeader });
    initColMap();
    renderMapping();
  } catch(e){ logErr('loadText: –ø–æ–º–∏–ª–∫–∞',e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-DETECT key column
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoDetectKeyCol() {
  const dataRows = S.rows.slice(1, Math.min(6, S.rows.length));
  let bestIdx = 0, bestScore = -1;

  S.headers.forEach((h, ci) => {
    let score = 0;
    if (/^[‚Ññ#]|–Ω–æ–º–µ—Ä|number|^id$|–∫–æ–ª–æ–Ω–∫–∞\s*1/i.test(h.trim())) score += 5;

    dataRows.forEach(row => {
      const v = norm(row[ci]??'');
      if (/^\d{10,14}$/.test(v)) score += 2;
      else if (/^\d{8,16}$/.test(v)) score += 1;
    });

    if (score > bestScore) { bestScore = score; bestIdx = ci; }
  });
  return bestIdx;
}

function getSampleValues(ci, count=3) {
  return S.rows.slice(1, count+1).map(r=>norm(r[ci]??'')).filter(Boolean);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initColMap() {
  if (S.colMap.length===S.headers.length) {
    S.headers.forEach((h,i)=>{S.colMap[i].original=h;});
    return;
  }
  const keyIdx = autoDetectKeyCol();
  S.colMap = S.headers.map((h,i)=>({ original:h, alias:h, visible:true, isKey:i===keyIdx }));
  logInfo('ColMap: —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ', { keyCol:`Col${keyIdx+1} ¬´${S.headers[keyIdx]||'?'}¬ª`, auto:true });
}

function setKeyCol(idx) {
  const prev = S.colMap.findIndex(c=>c.isKey);
  S.colMap.forEach((c,i)=>c.isKey=i===idx);
  logInfo('–ö–ª—é—á –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–º—ñ–Ω–µ–Ω–æ',{–≤—ñ–¥:S.headers[prev]||prev, –¥–æ:S.headers[idx]||idx});
  renderMapping();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER MAPPING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMapping() {
  if (!S.headers.length) return;
  document.getElementById('mapping-block').style.display='';

  // –ü–æ–∫–∞–∑—É—î–º–æ/–ø—Ä–∏—Ö–æ–≤—É—î–º–æ –±–∞–Ω–µ—Ä –ø—Ä–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
  document.getElementById('no-header-banner').classList.toggle('visible', S.syntheticHeader);

  const keyIdx = S.colMap.findIndex(c=>c.isKey);
  const previewRows = S.rows.slice(0, PREVIEW_ROWS+1);
  const pwrap = document.getElementById('preview-wrap');
  const thHtml = S.headers.map((h,i)=>`<th class="${i===keyIdx?'is-key-th':''}">${esc(h||`Col${i+1}`)}</th>`).join('');
  const tbodyHtml = previewRows.slice(1).map(row=>`<tr>${
    row.map((v,i)=>`<td class="${i===keyIdx?'is-key-td':''}" title="${esc(v)}">${esc(v)}</td>`).join('')
  }</tr>`).join('');
  pwrap.innerHTML = `<table class="preview-table"><thead><tr>${thHtml}</tr></thead><tbody>${tbodyHtml}</tbody></table>`;

  const list = document.getElementById('col-select-list');
  list.innerHTML = '';

  S.colMap.forEach((col,i) => {
    const samples = getSampleValues(i, 3);
    const isKey = col.isKey;
    const autoTag = isKey && autoDetectKeyCol()===i ? '<span class="auto-hint">‚ö° –∞–≤—Ç–æ-–≤–∏–∑–Ω–∞—á–µ–Ω–æ</span>' : '';

    const div = document.createElement('label');
    div.className = 'col-select-item' + (isKey?' is-key':'');
    div.innerHTML = `
      <input class="col-radio" type="radio" name="keycol" ${isKey?'checked':''} onchange="setKeyCol(${i})">
      <div class="col-radio-visual"></div>
      <div class="col-info">
        <div class="col-label-row">
          <span class="col-num-badge">–ö–æ–ª. ${i+1}</span>
          <input class="col-alias-input" type="text" value="${esc(col.alias)}"
            placeholder="–ù–∞–∑–≤–∞‚Ä¶"
            oninput="S.colMap[${i}].alias=this.value.trim()||S.colMap[${i}].original"
            onclick="event.stopPropagation()">
          ${autoTag}
        </div>
        <div class="col-sample">–ü—Ä–∏–∫–ª–∞–¥: <span>${esc(samples.join(' ¬∑ '))||'(–ø–æ—Ä–æ–∂–Ω—å–æ)'}</span></div>
      </div>
      <div class="col-right">
        <span class="key-badge-v2">üîë –ö–ª—é—á –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</span>
        <label class="vis-toggle" onclick="event.stopPropagation()">
          <input type="checkbox" ${col.visible?'checked':''} onchange="S.colMap[${i}].visible=this.checked">
          –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏
        </label>
      </div>`;
    list.appendChild(div);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VALIDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function validateNum(v) {
  if (!/^\d+$/.test(v)) return 'chars';
  if (v.length<NUM_MIN) return 'short';
  if (v.length>NUM_MAX) return 'long';
  return 'ok';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORE CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runCheck() {
  logInfo('‚îÅ‚îÅ‚îÅ –ó–∞–ø—É—Å–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ‚îÅ‚îÅ‚îÅ');
  try {
    const raw = document.getElementById('textarea').value.trim();
    if (!raw){ logWarn('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∫–∞—Å–æ–≤–∞–Ω–∞: –ø–æ—Ä–æ–∂–Ω—ñ –¥–∞–Ω—ñ'); alert('–°–ø–æ—á–∞—Ç–∫—É –≤—Å—Ç–∞–≤—Ç–µ –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –¥–∞–Ω—ñ.'); return; }
    loadText(raw);

    S.keyCol = S.colMap.findIndex(c=>c.isKey);
    if (S.keyCol<0) S.keyCol=0;
    const ci = S.keyCol;
    logInfo('–ö–ª—é—á–æ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞',{idx:ci, name:S.headers[ci]||'?'});

    const groups={},order=[],invalid=[];
    const statR={chars:0,short:0,long:0};

    for (let ri=1;ri<S.rows.length;ri++){
      let val=norm(S.rows[ri][ci]??'');
      if (!val) continue;
      const v=validateNum(val);
      if (v!=='ok'){ invalid.push({rowIdx:ri,value:val,reason:v}); statR[v]++; continue; }
      if (!groups[val]){groups[val]=[];order.push(val);}
      groups[val].push(ri);
    }

    S.groups=groups; S.order=order;
    S.dupOrder=order.filter(n=>groups[n].length>1);
    S.invalid=invalid;

    const totalRows=S.rows.length-1, dupNums=S.dupOrder.length;
    const dupRows=S.dupOrder.reduce((s,n)=>s+groups[n].length,0);
    const invCnt=invalid.length;

    logOk('–ü–µ—Ä–µ–≤—ñ—Ä–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ',{–≤—Å—å–æ–≥–æ:totalRows,—É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö:order.length,–¥—É–±–ª—ñ–≤:dupNums,—Ä—è–¥–∫—ñ–≤_–¥—É–±–ª—ñ–≤:dupRows,–Ω–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö:invCnt});
    if (dupNums>0){ logWarn(`–ó–Ω–∞–π–¥–µ–Ω–æ ${dupNums} –¥—É–±–ª—å–æ–≤–∞–Ω–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤ (${dupRows} —Ä—è–¥–∫—ñ–≤)`); }
    else { logOk('–î—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚Äî —Ñ–∞–π–ª —á–∏—Å—Ç–∏–π!'); }
    if (invCnt>0){ logWarn(`–ù–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤: ${invCnt}`,statR); }
    else { logOk('–í—Å—ñ –Ω–æ–º–µ—Ä–∏ –ø—Ä–æ–π—à–ª–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é!'); }

    set('s-total',totalRows); set('s-unique',order.length);
    set('s-dup',dupNums); set('s-rows',dupRows); set('s-invalid',invCnt);
    set('tc-dup',dupNums); set('tc-inv',invCnt);

    document.getElementById('results-block').style.display='block';
    document.getElementById('btn-dl-dup').disabled   = dupNums===0;
    document.getElementById('btn-dl-clean').disabled = order.length===0;
    document.getElementById('btn-dl-inv').disabled   = invCnt===0;

    const si=document.getElementById('search-input');
    si.value=''; si.disabled=dupNums===0;
    set('search-count',`${dupNums} –≥—Ä—É–ø`);

    renderDups(S.dupOrder);
    renderInvalid(S.invalid);
    if (dupNums===0&&invCnt>0) switchTab('inv'); else switchTab('dup');
    document.getElementById('results-block').scrollIntoView({behavior:'smooth',block:'start'});
  } catch(e){ logErr('runCheck: –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞',e.message); console.error(e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name) {
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  document.getElementById(`tab-${name}-btn`).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER DUPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function alias(ci){ return S.colMap[ci]?.alias||S.headers[ci]||`Col${ci+1}`; }
function vis(ci)  { return S.colMap[ci]?S.colMap[ci].visible:true; }

function renderDups(keys) {
  const list=document.getElementById('dup-list');
  if (!keys.length){
    list.innerHTML=`<div class="empty"><span class="empty-icon">‚úÖ</span><div class="empty-text">–î—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!</div></div>`;
    return;
  }
  list.innerHTML='';
  keys.forEach((num,gi)=>{
    const rowIdxs=S.groups[num];
    const g=document.createElement('div');
    g.className='dup-group'; g.style.animationDelay=`${gi*0.02}s`;
    const h=document.createElement('div');
    h.className='dup-header';
    h.innerHTML=`<span class="dup-num-label">${esc(num)}</span><div class="dup-meta"><span class="pill">${rowIdxs.length}√ó</span><span class="chevron">‚ñº</span></div>`;
    const b=document.createElement('div'); b.className='dup-body';
    const visCols=S.headers.map((_,ci)=>ci).filter(vis);
    rowIdxs.forEach(ri=>{
      const row=S.rows[ri];
      const item=document.createElement('div'); item.className='dup-row-item';
      const cells=visCols.map(ci=>`<div class="dup-col-cell"><div class="dup-col-name">${esc(alias(ci))}</div><div class="dup-col-val">${esc(row[ci]??'')}</div></div>`).join('');
      item.innerHTML=`<div class="dup-row-idx">—Ä—è–¥–æ–∫ ${ri}</div><div class="dup-cols">${cells}</div>`;
      b.appendChild(item);
    });
    h.addEventListener('click',()=>{
      const open=b.classList.toggle('open');
      h.classList.toggle('open',open);
      h.querySelector('.chevron').classList.toggle('r',open);
    });
    g.appendChild(h); g.appendChild(b); list.appendChild(g);
  });
}

function filterDups(){
  const q=document.getElementById('search-input').value.trim().toLowerCase();
  const f=q?S.dupOrder.filter(n=>n.includes(q)):S.dupOrder;
  renderDups(f); set('search-count',`${f.length} –∑ ${S.dupOrder.length} –≥—Ä—É–ø`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER INVALID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInvalid(items){
  const ci=S.keyCol;
  const visCols=S.headers.map((_,i)=>i).filter(i=>vis(i)&&i!==ci);
  document.getElementById('inv-thead').innerHTML=`<tr><th>–†—è–¥–æ–∫</th><th>${esc(alias(ci))}</th><th>–î–æ–≤–∂–∏–Ω–∞</th><th>–ü—Ä–∏—á–∏–Ω–∞</th>${visCols.map(i=>`<th>${esc(alias(i))}</th>`).join('')}</tr>`;
  renderInvalidBody(items,visCols); set('inv-count',`${items.length} –∑–∞–ø–∏—Å—ñ–≤`);
}

function renderInvalidBody(items,visCols){
  const tb=document.getElementById('inv-tbody');
  if (!visCols) visCols=S.headers.map((_,i)=>i).filter(i=>vis(i)&&i!==S.keyCol);
  if (!items.length){ tb.innerHTML=`<tr><td colspan="99" style="text-align:center;padding:32px;color:var(--muted)">–ù–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚úÖ</td></tr>`; return; }
  tb.innerHTML=items.map(({rowIdx,value,reason})=>{
    const row=S.rows[rowIdx], r=REASONS[reason]||{cls:'',text:reason};
    return `<tr><td style="color:var(--muted);font-size:11px">${rowIdx}</td><td><span class="invalid-val">${esc(value)}</span></td><td style="color:var(--muted)">${value.length}</td><td><span class="inv-reason ${r.cls}">${r.text}</span></td>${visCols.map(i=>`<td>${esc(row[i]??'')}</td>`).join('')}</tr>`;
  }).join('');
}

function filterInvalid(){
  const q=document.getElementById('inv-search').value.trim().toLowerCase();
  const visCols=S.headers.map((_,i)=>i).filter(i=>vis(i)&&i!==S.keyCol);
  const f=q?S.invalid.filter(x=>x.value.toLowerCase().includes(q)||REASONS[x.reason]?.text.toLowerCase().includes(q)):S.invalid;
  renderInvalidBody(f,visCols); set('inv-count',`${f.length} –∑ ${S.invalid.length} –∑–∞–ø–∏—Å—ñ–≤`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOWNLOADS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toCSV(rowIdxs){
  const sep=S.sep==='\t'?',':S.sep;
  const e=v=>`"${String(v??'').replace(/"/g,'""')}"`;
  // –Ø–∫—â–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω–∏–π ‚Äî –Ω–µ –≤–∫–ª—é—á–∞—î–º–æ –π–æ–≥–æ —É –≤–∏–≤—ñ–¥
  const headerRow = S.syntheticHeader
    ? S.colMap.map((_,ci)=>`–ù–æ–º–µ—Ä ${ci+1}`).join(sep)
    : S.headers.map((_,ci)=>e(alias(ci))).join(sep);
  return headerRow+'\n'+rowIdxs.map(ri=>S.rows[ri].map(v=>e(v)).join(sep)).join('\n');
}

function dl(content,filename){
  try{
    const blob=new Blob(['\uFEFF'+content],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    logOk(`–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${filename}`,{—Ä—è–¥–∫—ñ–≤:content.split('\n').length-1});
  }catch(e){logErr(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${filename}`,e.message);}
}

function downloadDuplicates(){
  logInfo('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥—É–±–ª—ñ–≤');
  const idxs=[]; S.dupOrder.forEach(n=>S.groups[n].forEach(ri=>idxs.push(ri)));
  if (idxs.length) dl(toCSV(idxs),'duplicates.csv'); else logWarn('–ù–µ–º–∞—î –¥—É–±–ª—ñ–≤ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
}
function downloadWithoutDuplicates(){
  logInfo('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∑ –¥—É–±–ª—ñ–≤');
  const idxs=S.order.map(n=>S.groups[n][0]);
  if (idxs.length) dl(toCSV(idxs),'without_duplicates.csv'); else logWarn('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö');
}
function downloadInvalid(){
  logInfo('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö');
  if (!S.invalid.length){logWarn('–ù–µ–º–∞—î –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö'); return;}
  dl(toCSV(S.invalid.map(x=>x.rowIdx)),'invalid_numbers.csv');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE I/O
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function readFile(file){
  if (!file){logWarn('–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ'); return;}
  logInfo('–§–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ',{name:file.name,size:file.size+' –±–∞–π—Ç'});
  document.getElementById('file-name').textContent='‚úì '+file.name;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      document.getElementById('textarea').value=ev.target.result;
      loadText(ev.target.result);
      logOk(`–§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω–æ: ${file.name}`);
    }catch(e){logErr(`–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è: ${file.name}`,e.message);}
  };
  r.onerror=()=>logErr('FileReader: –ø–æ–º–∏–ª–∫–∞',file.name);
  r.readAsText(file,'utf-8');
}

document.getElementById('file-input').addEventListener('change',e=>readFile(e.target.files[0]));
const dz=document.getElementById('dropzone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');logInfo('Drag & Drop');readFile(e.dataTransfer.files[0]);});
document.getElementById('textarea').addEventListener('input',e=>{ if(e.target.value.trim()) loadText(e.target.value); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function set(id,v){ document.getElementById(id).textContent=v; }

logInfo('–î–æ–¥–∞—Ç–æ–∫ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ',{version:'3.2.0',time:new Date().toLocaleString('uk-UA')});
</script>
</body>
</html>
