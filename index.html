<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ´ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ‚Ñ–Ğ² Ğ½Ğ¾Ğ¼ĞµÑ€Ñ–Ğ²</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #f0ede8;
  --bg2:     #e5e0d8;
  --bg3:     #d8d2c8;
  --ink:     #1a1714;
  --muted:   #8a8278;
  --accent:  #c0392b;
  --accent2: #1a6b3c;
  --accent3: #1a3a6b;
  --warn:    #b06000;
  --border:  #c8c2b8;
  --dbg-bg:  #0d1117;
  --dbg-line:#1c2128;
  --dbg-ok:  #3fb950;
  --dbg-err: #f85149;
  --dbg-warn:#d29922;
  --dbg-inf: #58a6ff;
  --dbg-muted:#6e7681;
}

body {
  font-family: 'IBM Plex Mono', monospace;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  padding: 40px 20px 80px;
}

.wrap { max-width: 1080px; margin: 0 auto; }

header {
  margin-bottom: 44px; padding-bottom: 28px;
  border-bottom: 2px solid var(--ink);
  display: flex; align-items: flex-end; justify-content: space-between;
  gap: 20px; flex-wrap: wrap;
}
header h1 {
  font-family: 'Syne', sans-serif;
  font-size: clamp(26px, 5vw, 50px);
  font-weight: 800; letter-spacing: -2px; line-height: 1;
}
header h1 em { font-style: normal; color: var(--accent); }
.header-sub {
  font-size: 11px; color: var(--muted);
  letter-spacing: 2px; text-transform: uppercase; padding-bottom: 4px;
}

.block {
  background: #fff; border: 1.5px solid var(--border); border-radius: 4px;
  padding: 26px 28px; margin-bottom: 18px;
  box-shadow: 4px 4px 0 var(--bg3); animation: fadeUp 0.3s ease both;
}
@keyframes fadeUp {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:translateY(0); }
}

.block-title {
  font-family: 'Syne', sans-serif;
  font-size: 11px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 18px;
  display: flex; align-items: center; gap: 10px;
}
.block-title::after { content:''; flex:1; height:1px; background:var(--border); }

textarea {
  width: 100%; height: 170px;
  background: var(--bg); border: 1.5px solid var(--border); border-radius: 4px;
  font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--ink);
  padding: 14px; resize: vertical; outline: none;
  transition: border-color 0.2s; line-height: 1.6;
}
textarea:focus { border-color: var(--ink); }
textarea::placeholder { color: var(--muted); }

.dropzone {
  position: relative; border: 2px dashed var(--border); border-radius: 4px;
  padding: 18px; text-align: center; margin-top: 14px; cursor: pointer;
  transition: all 0.2s; background: var(--bg); color: var(--muted); font-size: 12px;
}
.dropzone:hover, .dropzone.drag { border-color: var(--ink); background: var(--bg2); color: var(--ink); }
.dropzone input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
.dropzone-icon { font-size: 22px; display: block; margin-bottom: 4px; }
#file-name { margin-top:8px; font-size:12px; color:var(--accent2); font-weight:600; min-height:16px; }

/* Mapping */
.mapping-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(215px,1fr)); gap:10px; }
.map-item {
  background:var(--bg); border:1.5px solid var(--border); border-radius:4px;
  padding:12px 14px; display:flex; flex-direction:column; gap:6px;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.map-item.is-key { border-color:var(--accent3); background:#eef2fa; box-shadow:2px 2px 0 rgba(26,58,107,0.15); }
.map-col-num { font-size:9px; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); }
.map-original { font-size:12px; font-weight:700; color:var(--ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.map-alias-input {
  width:100%; padding:6px 10px;
  font-family:'IBM Plex Mono',monospace; font-size:12px;
  border:1.5px solid var(--border); border-radius:4px;
  background:#fff; color:var(--ink); outline:none; transition:border-color 0.2s;
}
.map-alias-input:focus { border-color:var(--accent3); }
.map-controls { display:flex; gap:10px; flex-wrap:wrap; margin-top:2px; }
.map-chk-row { display:flex; align-items:center; gap:5px; font-size:11px; color:var(--muted); cursor:pointer; white-space:nowrap; }
.map-chk-row input[type=checkbox] { cursor:pointer; }
.map-chk-row.key-chk { color:var(--accent3); font-weight:600; }
.map-chk-row.key-chk input[type=checkbox] { accent-color:var(--accent3); }
.map-chk-row.vis-chk input[type=checkbox] { accent-color:var(--accent); }
.key-badge {
  display:inline-flex; align-items:center; gap:4px;
  font-size:9px; font-weight:700; letter-spacing:1px; text-transform:uppercase;
  color:var(--accent3); background:rgba(26,58,107,0.1);
  padding:2px 7px; border-radius:20px; border:1px solid rgba(26,58,107,0.2);
}

/* Buttons */
.btn-row { display:flex; gap:10px; flex-wrap:wrap; }
.btn {
  font-family:'IBM Plex Mono',monospace; font-size:12px; font-weight:600;
  letter-spacing:0.3px; padding:10px 18px;
  border:1.5px solid transparent; border-radius:4px;
  cursor:pointer; transition:all 0.15s;
  display:inline-flex; align-items:center; gap:7px; white-space:nowrap;
}
.btn:disabled { opacity:0.3; cursor:not-allowed !important; transform:none !important; box-shadow:none !important; }
.btn-primary { background:var(--ink); color:#fff; border-color:var(--ink); box-shadow:3px 3px 0 var(--bg3); }
.btn-primary:not(:disabled):hover { background:var(--accent); border-color:var(--accent); transform:translate(-1px,-1px); box-shadow:4px 4px 0 var(--bg3); }
.btn-danger  { background:#fff; color:var(--accent);  border-color:var(--accent);  box-shadow:3px 3px 0 rgba(192,57,43,0.15); }
.btn-danger:not(:disabled):hover  { background:var(--accent);  color:#fff; transform:translate(-1px,-1px); box-shadow:4px 4px 0 rgba(192,57,43,0.2); }
.btn-success { background:#fff; color:var(--accent2); border-color:var(--accent2); box-shadow:3px 3px 0 rgba(26,107,60,0.15); }
.btn-success:not(:disabled):hover { background:var(--accent2); color:#fff; transform:translate(-1px,-1px); box-shadow:4px 4px 0 rgba(26,107,60,0.2); }
.btn-warn    { background:#fff; color:var(--warn);    border-color:var(--warn);    box-shadow:3px 3px 0 rgba(176,96,0,0.15); }
.btn-warn:not(:disabled):hover    { background:var(--warn);    color:#fff; transform:translate(-1px,-1px); box-shadow:4px 4px 0 rgba(176,96,0,0.2); }
.btn-ghost   { background:transparent; color:var(--muted); border-color:var(--border); box-shadow:none; }
.btn-ghost:hover { color:var(--ink); border-color:var(--ink); }

/* Stats */
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; margin-bottom:18px; }
.stat-card { border:1.5px solid var(--border); border-radius:4px; padding:16px 18px; background:var(--bg); position:relative; overflow:hidden; }
.stat-card::before { content:''; position:absolute; left:0;top:0;bottom:0; width:3px; }
.stat-card.c-total::before  { background:var(--accent3); }
.stat-card.c-unique::before { background:var(--accent2); }
.stat-card.c-dup::before    { background:var(--accent); }
.stat-card.c-rows::before   { background:#c07a1a; }
.stat-card.c-invalid::before{ background:var(--warn); }
.stat-num { font-family:'Syne',sans-serif; font-size:34px; font-weight:800; line-height:1; margin-bottom:4px; }
.stat-card.c-total   .stat-num { color:var(--accent3); }
.stat-card.c-unique  .stat-num { color:var(--accent2); }
.stat-card.c-dup     .stat-num { color:var(--accent); }
.stat-card.c-rows    .stat-num { color:#c07a1a; }
.stat-card.c-invalid .stat-num { color:var(--warn); }
.stat-lbl { font-size:10px; text-transform:uppercase; letter-spacing:1.5px; color:var(--muted); line-height:1.4; }

/* Tabs */
.tabs { display:flex; gap:0; border-bottom:1.5px solid var(--border); margin-bottom:20px; }
.tab-btn {
  font-family:'IBM Plex Mono',monospace; font-size:12px; font-weight:600;
  padding:9px 18px; border:none; background:none; cursor:pointer;
  color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1.5px;
  transition:all 0.15s; display:flex; align-items:center; gap:6px;
}
.tab-btn:hover { color:var(--ink); }
.tab-btn.active { color:var(--ink); border-bottom-color:var(--ink); }
.tab-btn.tab-warn.active { color:var(--warn); border-bottom-color:var(--warn); }
.tab-cnt { font-size:10px; font-weight:700; padding:1px 7px; border-radius:20px; background:var(--bg3); color:var(--muted); }
.tab-btn.active .tab-cnt { background:var(--ink); color:#fff; }
.tab-btn.tab-warn.active .tab-cnt { background:var(--warn); color:#fff; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* Search */
.search-row { display:flex; align-items:center; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
.search-input {
  flex:1; min-width:180px; max-width:320px; padding:8px 13px;
  font-family:'IBM Plex Mono',monospace; font-size:12px;
  border:1.5px solid var(--border); border-radius:4px;
  background:var(--bg); color:var(--ink); outline:none; transition:border-color 0.2s;
}
.search-input:focus { border-color:var(--ink); }
.search-input::placeholder { color:var(--muted); }
.count-badge { font-size:11px; color:var(--muted); }

/* Dup list */
.dup-list { display:flex; flex-direction:column; gap:7px; max-height:500px; overflow-y:auto; padding-right:4px; }
.dup-list::-webkit-scrollbar { width:5px; }
.dup-list::-webkit-scrollbar-track { background:var(--bg); }
.dup-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.dup-group { border:1.5px solid var(--border); border-radius:4px; overflow:hidden; animation:fadeUp 0.2s ease both; }
.dup-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 15px; background:var(--bg2); cursor:pointer;
  transition:background 0.15s; user-select:none; border-bottom:1.5px solid transparent;
}
.dup-header:hover { background:var(--bg3); }
.dup-header.open { border-bottom-color:var(--border); }
.dup-num-label { font-weight:700; font-size:13px; color:var(--accent); }
.dup-meta { display:flex; align-items:center; gap:8px; }
.pill { font-size:10px; font-weight:700; padding:2px 8px; border-radius:20px; background:var(--accent); color:#fff; }
.chevron { transition:transform 0.2s; font-size:11px; color:var(--muted); }
.chevron.r { transform:rotate(180deg); }
.dup-body { display:none; padding:10px 14px; background:#fff; }
.dup-body.open { display:block; }
.dup-row-item { display:grid; grid-template-columns:50px 1fr; gap:10px; padding:7px 0; border-bottom:1px solid var(--bg2); font-size:11px; align-items:start; }
.dup-row-item:last-child { border-bottom:none; }
.dup-row-idx { color:var(--muted); font-size:10px; padding-top:2px; }
.dup-cols { display:flex; flex-wrap:wrap; gap:6px 14px; }
.dup-col-cell { display:flex; flex-direction:column; gap:1px; }
.dup-col-name { font-size:9px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
.dup-col-val { font-size:12px; color:var(--ink); font-weight:500; }

/* Invalid table */
.invalid-list-wrap { max-height:480px; overflow-y:auto; }
.invalid-list-wrap::-webkit-scrollbar { width:5px; }
.invalid-list-wrap::-webkit-scrollbar-track { background:var(--bg); }
.invalid-list-wrap::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.invalid-table { width:100%; border-collapse:collapse; font-size:12px; }
.invalid-table th { text-align:left; padding:8px 12px; background:var(--bg2); border:1px solid var(--border); font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); font-weight:600; }
.invalid-table td { padding:8px 12px; border:1px solid var(--border); color:var(--ink); vertical-align:top; }
.invalid-table tr:nth-child(even) td { background:var(--bg); }
.invalid-table tr:hover td { background:#fef5f0; }
.invalid-val { font-weight:700; color:var(--warn); }
.inv-reason { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:600; letter-spacing:0.5px; padding:2px 8px; border-radius:20px; }
.inv-reason.r-chars { background:rgba(192,57,43,0.1); color:var(--accent); }
.inv-reason.r-short { background:rgba(176,96,0,0.1); color:var(--warn); }
.inv-reason.r-long  { background:rgba(26,58,107,0.1); color:var(--accent3); }

.empty { text-align:center; padding:44px 20px; color:var(--muted); }
.empty-icon { font-size:40px; display:block; margin-bottom:10px; }
.empty-text { font-size:13px; }

#results-block { display:none; }

/* â•â• DEBUG PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#debug-panel {
  background: var(--dbg-bg);
  border: 1.5px solid #30363d;
  border-radius: 4px;
  margin-bottom: 18px;
  overflow: hidden;
  box-shadow: 4px 4px 0 #0a0d10;
  font-family: 'IBM Plex Mono', monospace;
}

.dbg-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 18px;
  background: #161b22;
  border-bottom: 1px solid #30363d;
  cursor: pointer;
  user-select: none;
}

.dbg-header:hover { background: #1c2128; }

.dbg-title {
  display: flex; align-items: center; gap: 10px;
  font-size: 12px; font-weight: 600; color: #c9d1d9;
  letter-spacing: 1px; text-transform: uppercase;
}

.dbg-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--dbg-ok);
  box-shadow: 0 0 6px var(--dbg-ok);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity:1; }
  50% { opacity:0.4; }
}

.dbg-dot.err { background:var(--dbg-err); box-shadow:0 0 6px var(--dbg-err); }

.dbg-controls {
  display: flex; align-items: center; gap: 8px;
}

.dbg-cnt {
  font-size: 11px; color: var(--dbg-muted);
  background: #21262d; padding: 2px 8px; border-radius: 20px;
}
.dbg-cnt.has-err { color: var(--dbg-err); background: rgba(248,81,73,0.1); }

.dbg-body {
  display: none;
  height: 280px;
  overflow-y: auto;
  padding: 10px 0;
}
.dbg-body.open { display: block; }

.dbg-body::-webkit-scrollbar { width: 5px; }
.dbg-body::-webkit-scrollbar-track { background: #0d1117; }
.dbg-body::-webkit-scrollbar-thumb { background: #30363d; border-radius:3px; }

.dbg-line {
  display: grid;
  grid-template-columns: 90px 48px 1fr;
  gap: 0;
  padding: 3px 18px;
  font-size: 11px;
  line-height: 1.6;
  border-bottom: 1px solid transparent;
  transition: background 0.1s;
}
.dbg-line:hover { background: var(--dbg-line); }

.dbg-ts { color: var(--dbg-muted); }
.dbg-lvl {
  font-weight: 700; font-size: 10px; letter-spacing: 0.5px;
  padding: 1px 0; text-align: left;
}
.dbg-msg { color: #c9d1d9; word-break: break-all; }

.lvl-ok   { color: var(--dbg-ok); }
.lvl-err  { color: var(--dbg-err); }
.lvl-warn { color: var(--dbg-warn); }
.lvl-info { color: var(--dbg-inf); }

.dbg-line.level-err  { background: rgba(248,81,73,0.06); }
.dbg-line.level-warn { background: rgba(210,153,34,0.04); }

.dbg-footer {
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
  padding: 10px 18px;
  background: #161b22;
  border-top: 1px solid #30363d;
  flex-wrap: wrap;
}

.dbg-filter {
  display: flex; gap: 6px; flex-wrap: wrap;
}

.dbg-filter-btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; font-weight: 600; letter-spacing: 0.5px;
  padding: 3px 10px; border-radius: 20px;
  border: 1px solid #30363d;
  background: #21262d; color: var(--dbg-muted);
  cursor: pointer; transition: all 0.15s;
}
.dbg-filter-btn:hover { border-color: #58a6ff; color: #58a6ff; }
.dbg-filter-btn.active { background: #1f3a5c; border-color: var(--dbg-inf); color: var(--dbg-inf); }
.dbg-filter-btn.f-ok.active   { background:rgba(63,185,80,0.1);  border-color:var(--dbg-ok);   color:var(--dbg-ok); }
.dbg-filter-btn.f-err.active  { background:rgba(248,81,73,0.1);  border-color:var(--dbg-err);  color:var(--dbg-err); }
.dbg-filter-btn.f-warn.active { background:rgba(210,153,34,0.1); border-color:var(--dbg-warn); color:var(--dbg-warn); }
.dbg-filter-btn.f-info.active { background:rgba(88,166,255,0.1); border-color:var(--dbg-inf);  color:var(--dbg-inf); }

.dbg-dl-btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px; font-weight: 600;
  padding: 4px 12px;
  background: #21262d; color: #c9d1d9;
  border: 1px solid #30363d; border-radius: 4px;
  cursor: pointer; transition: all 0.15s;
  display: flex; align-items: center; gap: 6px;
}
.dbg-dl-btn:hover { background: #292e36; border-color: var(--dbg-ok); color: var(--dbg-ok); }

.dbg-clear-btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px; font-weight: 600;
  padding: 4px 10px;
  background: transparent; color: var(--dbg-muted);
  border: 1px solid #30363d; border-radius: 4px;
  cursor: pointer; transition: all 0.15s;
}
.dbg-clear-btn:hover { border-color:var(--dbg-err); color:var(--dbg-err); }
</style>
</head>
<body>
<div class="wrap">

<header>
  <div><h1>Ğ”Ğ£Ğ‘Ğ›Ğ†<em>.</em>CSV</h1></div>
  <div class="header-sub">ĞĞ½Ğ°Ğ»Ñ–Ğ· Â· Ğ’Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ Â· ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ</div>
</header>

<!-- DEBUG PANEL -->
<div id="debug-panel">
  <div class="dbg-header" onclick="toggleDbg()">
    <div class="dbg-title">
      <span class="dbg-dot" id="dbg-dot"></span>
      ğŸ› Debug Log
    </div>
    <div class="dbg-controls">
      <span class="dbg-cnt" id="dbg-cnt">0 Ğ¿Ğ¾Ğ´Ñ–Ğ¹</span>
      <span style="font-size:11px;color:#6e7681" id="dbg-chevron">â–¼</span>
    </div>
  </div>
  <div class="dbg-body" id="dbg-body"></div>
  <div class="dbg-footer">
    <div class="dbg-filter">
      <button class="dbg-filter-btn active"    id="ff-all"  onclick="dbgFilter('all')">Ğ’ÑÑ–</button>
      <button class="dbg-filter-btn f-ok"      id="ff-ok"   onclick="dbgFilter('ok')">âœ“ Ğ£ÑĞ¿Ñ–Ñ…</button>
      <button class="dbg-filter-btn f-err"     id="ff-err"  onclick="dbgFilter('err')">âœ• ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ¸</button>
      <button class="dbg-filter-btn f-warn"    id="ff-warn" onclick="dbgFilter('warn')">âš  ĞŸĞ¾Ğ¿ĞµÑ€ĞµĞ´Ğ¶ĞµĞ½Ğ½Ñ</button>
      <button class="dbg-filter-btn f-info"    id="ff-info" onclick="dbgFilter('info')">â„¹ Ğ†Ğ½Ñ„Ğ¾</button>
    </div>
    <div style="display:flex;gap:6px;">
      <button class="dbg-clear-btn" onclick="clearLog()">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸</button>
      <button class="dbg-dl-btn" onclick="downloadLog()">â¬‡ Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ .log</button>
    </div>
  </div>
</div>

<!-- 1. Ğ”Ğ°Ğ½Ñ– -->
<div class="block">
  <div class="block-title">ğŸ“‚ Ğ”Ğ°Ğ½Ñ–</div>
  <textarea id="textarea" placeholder="Ğ’ÑÑ‚Ğ°Ğ²Ñ‚Ğµ CSV / TSV / Tab-Ğ´Ğ°Ğ½Ñ– ÑÑĞ´Ğ¸ (Ctrl+V)â€¦"></textarea>
  <div class="dropzone" id="dropzone">
    <input type="file" id="file-input" accept=".csv,.tsv,.txt">
    <span class="dropzone-icon">ğŸ“„</span>
    ĞŸĞµÑ€ĞµÑ‚ÑĞ³Ğ½Ñ–Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ°Ğ±Ğ¾ Ğ½Ğ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ (.csv / .tsv / .txt)
  </div>
  <div id="file-name"></div>
</div>

<!-- 2. ĞœĞ°Ğ¿Ñ–Ğ½Ğ³ -->
<div class="block" id="mapping-block" style="display:none;">
  <div class="block-title">ğŸ—‚ ĞœĞ°Ğ¿Ñ–Ğ½Ğ³ ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº</div>
  <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">
    ĞŸĞ¾Ğ·Ğ½Ğ°Ñ‡Ñ‚Ğµ <strong>ğŸ”‘ ĞšĞ»ÑÑ‡ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸</strong> â€” ÑĞºĞ° ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° Ğ¼Ñ–ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ñ–Ğ·Ñƒ Ğ´ÑƒĞ±Ğ»Ñ–Ğ².<br>
    Ğ¢Ğ°ĞºĞ¾Ğ¶ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ¿ĞµÑ€ĞµĞ¹Ğ¼ĞµĞ½ÑƒĞ²Ğ°Ñ‚Ğ¸ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ Ñ‚Ğ° Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸, ÑĞºÑ– Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñƒ Ğ·Ğ²Ñ–Ñ‚Ñ–.
  </p>
  <div class="mapping-grid" id="mapping-grid"></div>
</div>

<!-- 3. Ğ”Ñ–Ñ— -->
<div class="block">
  <div class="block-title">âš™ï¸ Ğ”Ñ–Ñ—</div>
  <div class="btn-row">
    <button class="btn btn-primary" onclick="runCheck()">ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸</button>
    <button class="btn btn-danger"  id="btn-dl-dup"   onclick="downloadDuplicates()"       disabled>ğŸ“¥ Ğ”ÑƒĞ±Ğ»Ñ– (CSV)</button>
    <button class="btn btn-success" id="btn-dl-clean" onclick="downloadWithoutDuplicates()" disabled>âœ¨ Ğ‘ĞµĞ· Ğ´ÑƒĞ±Ğ»Ñ–Ğ² (CSV)</button>
    <button class="btn btn-warn"    id="btn-dl-inv"   onclick="downloadInvalid()"           disabled>âš ï¸ ĞĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ñ– (CSV)</button>
  </div>
</div>

<!-- 4. Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸ -->
<div id="results-block">
  <div class="block">
    <div class="block-title">ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</div>
    <div class="stats-grid">
      <div class="stat-card c-total">  <div class="stat-num" id="s-total">0</div>  <div class="stat-lbl">Ğ’ÑÑŒĞ¾Ğ³Ğ¾ Ñ€ÑĞ´ĞºÑ–Ğ²</div></div>
      <div class="stat-card c-unique"> <div class="stat-num" id="s-unique">0</div> <div class="stat-lbl">Ğ£Ğ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ñ… â„–</div></div>
      <div class="stat-card c-dup">    <div class="stat-num" id="s-dup">0</div>    <div class="stat-lbl">â„– Ğ· Ğ´ÑƒĞ±Ğ»ÑĞ¼Ğ¸</div></div>
      <div class="stat-card c-rows">   <div class="stat-num" id="s-rows">0</div>   <div class="stat-lbl">Ğ ÑĞ´ĞºÑ–Ğ²-Ğ´ÑƒĞ±Ğ»Ñ–Ğ²</div></div>
      <div class="stat-card c-invalid"><div class="stat-num" id="s-invalid">0</div><div class="stat-lbl">ĞĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ñ… â„–</div></div>
    </div>
  </div>

  <div class="block">
    <div class="tabs">
      <button class="tab-btn active"   id="tab-dup-btn" onclick="switchTab('dup')">
        ğŸ” Ğ”ÑƒĞ±Ğ»Ñ– <span class="tab-cnt" id="tc-dup">0</span>
      </button>
      <button class="tab-btn tab-warn" id="tab-inv-btn" onclick="switchTab('inv')">
        âš ï¸ ĞĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ñ– Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¸ <span class="tab-cnt" id="tc-inv">0</span>
      </button>
    </div>
    <div class="tab-panel active" id="tab-dup">
      <div class="search-row">
        <input class="search-input" id="search-input" placeholder="ğŸ” ĞŸĞ¾ÑˆÑƒĞº Ğ·Ğ° Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼â€¦" oninput="filterDups()" disabled>
        <span class="count-badge" id="search-count"></span>
      </div>
      <div class="dup-list" id="dup-list"></div>
    </div>
    <div class="tab-panel" id="tab-inv">
      <div class="search-row">
        <input class="search-input" id="inv-search" placeholder="ğŸ” ĞŸĞ¾ÑˆÑƒĞºâ€¦" oninput="filterInvalid()">
        <span class="count-badge" id="inv-count"></span>
      </div>
      <div class="invalid-list-wrap">
        <table class="invalid-table">
          <thead id="inv-thead"></thead>
          <tbody id="inv-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div><!-- /wrap -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUG LOGGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LOG = [];
let dbgOpen     = false;
let dbgActiveFilter = 'all';
let dbgHasErr   = false;

function ts() {
  const n = new Date();
  return `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}.${String(n.getMilliseconds()).padStart(3,'0')}`;
}

// Levels: ok | err | warn | info
function log(level, msg, data) {
  const entry = { ts: ts(), level, msg, data, date: new Date().toISOString() };
  LOG.push(entry);
  if (level === 'err') dbgHasErr = true;

  updateDbgHeader();
  if (dbgOpen) appendLogLine(entry);

  // also mirror to browser console
  const fn = level === 'err' ? 'error' : level === 'warn' ? 'warn' : 'log';
  console[fn](`[${entry.ts}] [${level.toUpperCase()}] ${msg}`, data ?? '');
}

function logOk(msg, data)   { log('ok',   msg, data); }
function logErr(msg, data)  { log('err',  msg, data); }
function logWarn(msg, data) { log('warn', msg, data); }
function logInfo(msg, data) { log('info', msg, data); }

function updateDbgHeader() {
  const total = LOG.length;
  const errCnt = LOG.filter(e => e.level === 'err').length;
  const cnt = document.getElementById('dbg-cnt');
  cnt.textContent = `${total} Ğ¿Ğ¾Ğ´Ñ–Ğ¹${errCnt ? ' Â· ' + errCnt + ' Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº' : ''}`;
  cnt.className = 'dbg-cnt' + (errCnt ? ' has-err' : '');
  const dot = document.getElementById('dbg-dot');
  dot.className = 'dbg-dot' + (errCnt ? ' err' : '');
}

function appendLogLine(entry) {
  if (dbgActiveFilter !== 'all' && entry.level !== dbgActiveFilter) return;
  const body = document.getElementById('dbg-body');
  const div = document.createElement('div');
  div.className = `dbg-line level-${entry.level}`;
  const lvlMap = { ok:'âœ“ OK', err:'âœ• ERR', warn:'âš  WARN', info:'â„¹ INFO' };
  div.innerHTML = `
    <span class="dbg-ts">${esc(entry.ts)}</span>
    <span class="dbg-lvl lvl-${entry.level}">${lvlMap[entry.level]||entry.level}</span>
    <span class="dbg-msg">${esc(entry.msg)}${entry.data !== undefined ? ' <span style="opacity:0.5">â†’ '+esc(JSON.stringify(entry.data))+'</span>' : ''}</span>`;
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}

function redrawLog() {
  const body = document.getElementById('dbg-body');
  body.innerHTML = '';
  LOG.forEach(e => {
    if (dbgActiveFilter === 'all' || e.level === dbgActiveFilter) appendLogLine(e);
  });
}

function toggleDbg() {
  dbgOpen = !dbgOpen;
  document.getElementById('dbg-body').classList.toggle('open', dbgOpen);
  document.getElementById('dbg-chevron').textContent = dbgOpen ? 'â–²' : 'â–¼';
  if (dbgOpen) redrawLog();
}

function dbgFilter(f) {
  dbgActiveFilter = f;
  document.querySelectorAll('.dbg-filter-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`ff-${f}`).classList.add('active');
  if (dbgOpen) redrawLog();
}

function clearLog() {
  LOG.length = 0;
  dbgHasErr = false;
  document.getElementById('dbg-body').innerHTML = '';
  updateDbgHeader();
  logInfo('Ğ›Ğ¾Ğ³ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ¾ Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ');
}

function downloadLog() {
  const lines = LOG.map(e => {
    const lvl = e.level.toUpperCase().padEnd(4);
    const data = e.data !== undefined ? ' | DATA: ' + JSON.stringify(e.data) : '';
    return `[${e.date}] [${lvl}] ${e.msg}${data}`;
  });
  const header = [
    '='.repeat(70),
    'DUPLICATE CHECKER â€” DEBUG LOG',
    `Ğ—Ğ³ĞµĞ½ĞµÑ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${new Date().toLocaleString('uk-UA')}`,
    `Ğ’ÑÑŒĞ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´Ñ–Ğ¹: ${LOG.length} | ĞŸĞ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº: ${LOG.filter(e=>e.level==='err').length}`,
    '='.repeat(70),
    ''
  ];
  const blob = new Blob([header.join('\n') + lines.join('\n')], { type:'text/plain;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `debug_${new Date().toISOString().replace(/[:.]/g,'-').slice(0,19)}.log`;
  a.click();
  logOk('Ğ›Ğ¾Ğ³ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾ Ñƒ Ñ„Ğ°Ğ¹Ğ»');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  rows: [], headers: [], sep: '\t',
  colMap: [], groups: {}, order: [], dupOrder: [], invalid: [], keyCol: 0,
};

const NUM_MIN = 10, NUM_MAX = 14;
const REASONS = {
  chars: { cls:'r-chars', text:'â›” ĞĞµÑ‡Ğ¸ÑĞ»Ğ¾Ğ²Ñ– ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸' },
  short: { cls:'r-short', text:`ğŸ“ ĞœĞµĞ½ÑˆĞµ ${NUM_MIN} Ñ†Ğ¸Ñ„Ñ€` },
  long:  { cls:'r-long',  text:`ğŸ“ Ğ‘Ñ–Ğ»ÑŒÑˆĞµ ${NUM_MAX} Ñ†Ğ¸Ñ„Ñ€` },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function detectSep(line) {
  if (line.includes('\t')) return '\t';
  const s = (line.match(/;/g)||[]).length, c = (line.match(/,/g)||[]).length;
  return s >= c ? ';' : ',';
}

function parseLine(line, sep) {
  if (sep !== ',') return line.split(sep).map(c => c.trim().replace(/^"|"$/g,''));
  const res=[]; let cur='', inQ=false;
  for (let i=0;i<line.length;i++) {
    const ch=line[i];
    if (ch==='"') { inQ=!inQ; continue; }
    if (ch===','&&!inQ) { res.push(cur.trim()); cur=''; continue; }
    cur+=ch;
  }
  res.push(cur.trim());
  return res;
}

function norm(v) { return String(v??'').replace(/^'+/,'').trim(); }

function loadText(text) {
  try {
    const lines = text.trim().split(/\r?\n/).filter(l=>l.trim());
    if (lines.length < 2) {
      logWarn('loadText: Ğ¼ĞµĞ½ÑˆĞµ 2 Ñ€ÑĞ´ĞºÑ–Ğ², Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾', { lines: lines.length });
      return;
    }
    S.sep = detectSep(lines[0]);
    const parsed = lines.map(l=>parseLine(l,S.sep));
    S.headers = parsed[0]||[];
    S.rows = parsed;
    logInfo('Ğ”Ğ°Ğ½Ñ– Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾', { rows: parsed.length - 1, cols: S.headers.length, sep: S.sep === '\t' ? 'TAB' : S.sep });
    initColMap();
    renderMapping();
  } catch(e) {
    logErr('loadText: Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ñƒ', e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLUMN MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initColMap() {
  if (S.colMap.length === S.headers.length) {
    S.headers.forEach((h,i) => { S.colMap[i].original = h; });
    logInfo('ColMap: Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ (Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾ Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼Ğ¸)');
    return;
  }
  let keyIdx = S.headers.findIndex(h => /^[â„–#]|^Ğ½Ğ¾Ğ¼ĞµÑ€$|^number$|^id$/i.test(h.trim()));
  if (keyIdx < 0) keyIdx = 0;
  S.colMap = S.headers.map((h,i) => ({ original:h, alias:h, visible:true, isKey:i===keyIdx }));
  logInfo('ColMap: Ñ–Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾', { keyCol: S.headers[keyIdx] || `Col${keyIdx+1}`, totalCols: S.headers.length });
}

function setKeyCol(idx) {
  const prev = S.colMap.findIndex(c=>c.isKey);
  S.colMap.forEach((c,i)=>c.isKey = i===idx);
  logInfo('ColMap: ĞºĞ»ÑÑ‡ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ·Ğ¼Ñ–Ğ½ĞµĞ½Ğ¾', { Ğ²Ñ–Ğ´: S.headers[prev]||prev, Ğ´Ğ¾: S.headers[idx]||idx });
  renderMapping();
}

function renderMapping() {
  if (!S.headers.length) return;
  document.getElementById('mapping-block').style.display = '';
  const grid = document.getElementById('mapping-grid');
  grid.innerHTML = '';
  S.colMap.forEach((col,i) => {
    const d = document.createElement('div');
    d.className = 'map-item' + (col.isKey?' is-key':'');
    d.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;flex-wrap:wrap;">
        <div class="map-col-num">ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ° ${i+1}</div>
        ${col.isKey?'<span class="key-badge">ğŸ”‘ ĞšĞ»ÑÑ‡ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸</span>':''}
      </div>
      <div class="map-original" title="${esc(col.original)}">${esc(col.original)||'(Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ)'}</div>
      <input class="map-alias-input" type="text" placeholder="ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼â€¦" value="${esc(col.alias)}"
        oninput="S.colMap[${i}].alias=this.value.trim()||S.colMap[${i}].original">
      <div class="map-controls">
        <label class="map-chk-row key-chk">
          <input type="checkbox" ${col.isKey?'checked':''} onchange="setKeyCol(${i})">
          ğŸ”‘ ĞšĞ»ÑÑ‡ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸
        </label>
        <label class="map-chk-row vis-chk">
          <input type="checkbox" ${col.visible?'checked':''} onchange="S.colMap[${i}].visible=this.checked">
          ĞŸĞ¾ĞºĞ°Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸
        </label>
      </div>`;
    grid.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VALIDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function validateNum(v) {
  if (!/^\d+$/.test(v)) return 'chars';
  if (v.length < NUM_MIN) return 'short';
  if (v.length > NUM_MAX) return 'long';
  return 'ok';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runCheck() {
  logInfo('â”â”â” Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ â”â”â”');
  try {
    const raw = document.getElementById('textarea').value.trim();
    if (!raw) {
      logWarn('ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° ÑĞºĞ°ÑĞ¾Ğ²Ğ°Ğ½Ğ°: Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ– Ğ´Ğ°Ğ½Ñ–');
      alert('Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ²ÑÑ‚Ğ°Ğ²Ñ‚Ğµ Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ñ‚Ğµ Ğ´Ğ°Ğ½Ñ–.');
      return;
    }

    loadText(raw);
    S.keyCol = S.colMap.findIndex(c=>c.isKey);
    if (S.keyCol < 0) S.keyCol = 0;
    const ci = S.keyCol;
    logInfo('ĞšĞ»ÑÑ‡Ğ¾Ğ²Ğ° ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ°', { idx: ci, name: S.headers[ci]||'?' });

    const groups={}, order=[], invalid=[];
    const statByReason = { chars:0, short:0, long:0 };

    for (let ri=1; ri<S.rows.length; ri++) {
      const val = norm(S.rows[ri][ci]??'');
      if (!val) continue;
      const v = validateNum(val);
      if (v !== 'ok') {
        invalid.push({ rowIdx:ri, value:val, reason:v });
        statByReason[v]++;
        continue;
      }
      if (!groups[val]) { groups[val]=[]; order.push(val); }
      groups[val].push(ri);
    }

    S.groups   = groups;
    S.order    = order;
    S.dupOrder = order.filter(n=>groups[n].length>1);
    S.invalid  = invalid;

    const totalRows = S.rows.length - 1;
    const dupNums   = S.dupOrder.length;
    const dupRows   = S.dupOrder.reduce((s,n)=>s+groups[n].length,0);
    const invCnt    = invalid.length;

    // Log results
    logOk('ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾', {
      Ğ²ÑÑŒĞ¾Ğ³Ğ¾_Ñ€ÑĞ´ĞºÑ–Ğ²: totalRows,
      ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ñ…: order.length,
      Ğ½Ğ¾Ğ¼ĞµÑ€Ñ–Ğ²_Ğ·_Ğ´ÑƒĞ±Ğ»ÑĞ¼Ğ¸: dupNums,
      Ñ€ÑĞ´ĞºÑ–Ğ²_Ğ´ÑƒĞ±Ğ»Ñ–Ğ²: dupRows,
      Ğ½ĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ñ…: invCnt,
    });

    if (dupNums > 0) {
      logWarn(`Ğ—Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ ${dupNums} Ğ´ÑƒĞ±Ğ»ÑŒĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ñ–Ğ² (${dupRows} Ñ€ÑĞ´ĞºÑ–Ğ²)`);
      S.dupOrder.slice(0,5).forEach(n => {
        logWarn(`  Ğ”ÑƒĞ±Ğ»ÑŒ: â„–${n}`, { Ñ€Ğ°Ğ·Ñ–Ğ²: groups[n].length, Ñ€ÑĞ´ĞºĞ¸: groups[n].map(r=>r+1) });
      });
      if (S.dupOrder.length > 5) logWarn(`  ... Ñ‚Ğ° Ñ‰Ğµ ${S.dupOrder.length-5} Ğ´ÑƒĞ±Ğ»Ñ–Ğ²`);
    } else {
      logOk('Ğ”ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ‚Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â€” Ñ„Ğ°Ğ¹Ğ» Ñ‡Ğ¸ÑÑ‚Ğ¸Ğ¹!');
    }

    if (invCnt > 0) {
      logWarn(`ĞĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ñ–Ğ²: ${invCnt}`, statByReason);
      invalid.slice(0,5).forEach(x => {
        logWarn(`  ĞĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ğ¹ Ñ€ÑĞ´Ğ¾Ğº ${x.rowIdx+1}`, { Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ: x.value, Ğ´Ğ¾Ğ²Ğ¶Ğ¸Ğ½Ğ°: x.value.length, Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: x.reason });
      });
      if (invalid.length > 5) logWarn(`  ... Ñ‚Ğ° Ñ‰Ğµ ${invalid.length-5}`);
    } else {
      logOk('Ğ’ÑÑ– Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¸ Ğ²Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ!');
    }

    set('s-total',   totalRows);
    set('s-unique',  order.length);
    set('s-dup',     dupNums);
    set('s-rows',    dupRows);
    set('s-invalid', invCnt);
    set('tc-dup',    dupNums);
    set('tc-inv',    invCnt);

    document.getElementById('results-block').style.display = 'block';
    document.getElementById('btn-dl-dup').disabled   = dupNums === 0;
    document.getElementById('btn-dl-clean').disabled = order.length === 0;
    document.getElementById('btn-dl-inv').disabled   = invCnt === 0;

    const si = document.getElementById('search-input');
    si.value=''; si.disabled = dupNums===0;
    set('search-count', `${dupNums} Ğ³Ñ€ÑƒĞ¿`);

    renderDups(S.dupOrder);
    renderInvalid(S.invalid);

    if (dupNums===0 && invCnt>0) switchTab('inv');
    else switchTab('dup');

    document.getElementById('results-block').scrollIntoView({ behavior:'smooth', block:'start' });

  } catch(e) {
    logErr('runCheck: ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ°', e.message);
    console.error(e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  document.getElementById(`tab-${name}-btn`).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER DUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function alias(ci) { return S.colMap[ci]?.alias||S.headers[ci]||`Col${ci+1}`; }
function vis(ci)   { return S.colMap[ci] ? S.colMap[ci].visible : true; }

function renderDups(keys) {
  const list = document.getElementById('dup-list');
  if (!keys.length) {
    list.innerHTML = `<div class="empty"><span class="empty-icon">âœ…</span><div class="empty-text">Ğ”ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ‚Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾!</div></div>`;
    return;
  }
  list.innerHTML = '';
  keys.forEach((num,gi) => {
    const rowIdxs = S.groups[num];
    const g = document.createElement('div');
    g.className='dup-group'; g.style.animationDelay=`${gi*0.02}s`;
    const h = document.createElement('div');
    h.className='dup-header';
    h.innerHTML=`
      <span class="dup-num-label">${esc(num)}</span>
      <div class="dup-meta"><span class="pill">${rowIdxs.length}Ã—</span><span class="chevron">â–¼</span></div>`;
    const b = document.createElement('div');
    b.className='dup-body';
    const visCols = S.headers.map((_,ci)=>ci).filter(vis);
    rowIdxs.forEach(ri => {
      const row=S.rows[ri];
      const item=document.createElement('div');
      item.className='dup-row-item';
      const cells=visCols.map(ci=>`
        <div class="dup-col-cell">
          <div class="dup-col-name">${esc(alias(ci))}</div>
          <div class="dup-col-val">${esc(row[ci]??'')}</div>
        </div>`).join('');
      item.innerHTML=`<div class="dup-row-idx">Ñ€ÑĞ´Ğ¾Ğº ${ri+1}</div><div class="dup-cols">${cells}</div>`;
      b.appendChild(item);
    });
    h.addEventListener('click',()=>{
      const open=b.classList.toggle('open');
      h.classList.toggle('open',open);
      h.querySelector('.chevron').classList.toggle('r',open);
    });
    g.appendChild(h); g.appendChild(b); list.appendChild(g);
  });
}

function filterDups() {
  const q=document.getElementById('search-input').value.trim().toLowerCase();
  const f=q?S.dupOrder.filter(n=>n.includes(q)):S.dupOrder;
  renderDups(f);
  set('search-count',`${f.length} Ğ· ${S.dupOrder.length} Ğ³Ñ€ÑƒĞ¿`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER INVALID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInvalid(items) {
  const ci=S.keyCol;
  const visCols=S.headers.map((_,i)=>i).filter(i=>vis(i)&&i!==ci);
  document.getElementById('inv-thead').innerHTML=`<tr>
    <th>Ğ ÑĞ´Ğ¾Ğº</th><th>${esc(alias(ci))}</th><th>Ğ”Ğ¾Ğ²Ğ¶Ğ¸Ğ½Ğ°</th><th>ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
    ${visCols.map(i=>`<th>${esc(alias(i))}</th>`).join('')}
  </tr>`;
  renderInvalidBody(items,visCols);
  set('inv-count',`${items.length} Ğ·Ğ°Ğ¿Ğ¸ÑÑ–Ğ²`);
}

function renderInvalidBody(items,visCols) {
  const tb=document.getElementById('inv-tbody');
  if (!visCols) visCols=S.headers.map((_,i)=>i).filter(i=>vis(i)&&i!==S.keyCol);
  if (!items.length) {
    tb.innerHTML=`<tr><td colspan="99" style="text-align:center;padding:32px;color:var(--muted)">ĞĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ âœ…</td></tr>`;
    return;
  }
  tb.innerHTML=items.map(({rowIdx,value,reason})=>{
    const row=S.rows[rowIdx];
    const r=REASONS[reason]||{cls:'',text:reason};
    const dataCells=visCols.map(i=>`<td>${esc(row[i]??'')}</td>`).join('');
    return `<tr>
      <td style="color:var(--muted);font-size:11px">${rowIdx+1}</td>
      <td><span class="invalid-val">${esc(value)}</span></td>
      <td style="color:var(--muted)">${value.length}</td>
      <td><span class="inv-reason ${r.cls}">${r.text}</span></td>
      ${dataCells}
    </tr>`;
  }).join('');
}

function filterInvalid() {
  const q=document.getElementById('inv-search').value.trim().toLowerCase();
  const visCols=S.headers.map((_,i)=>i).filter(i=>vis(i)&&i!==S.keyCol);
  const f=q?S.invalid.filter(x=>x.value.toLowerCase().includes(q)||REASONS[x.reason]?.text.toLowerCase().includes(q)):S.invalid;
  renderInvalidBody(f,visCols);
  set('inv-count',`${f.length} Ğ· ${S.invalid.length} Ğ·Ğ°Ğ¿Ğ¸ÑÑ–Ğ²`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOWNLOADS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toCSV(rowIdxs) {
  const sep=S.sep==='\t'?',':S.sep;
  const e=v=>`"${String(v??'').replace(/"/g,'""')}"`;
  const head=S.headers.map((_,ci)=>e(alias(ci))).join(sep);
  const body=rowIdxs.map(ri=>S.rows[ri].map(v=>e(v)).join(sep)).join('\n');
  return head+'\n'+body;
}

function dl(content,filename) {
  try {
    const blob=new Blob(['\uFEFF'+content],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    logOk(`Ğ¤Ğ°Ğ¹Ğ» Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾: ${filename}`, { Ñ€ÑĞ´ĞºÑ–Ğ²: content.split('\n').length - 1 });
  } catch(e) {
    logErr(`ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñƒ: ${filename}`, e.message);
  }
}

function downloadDuplicates() {
  logInfo('Ğ—Ğ°Ğ¿Ğ¸Ñ‚: Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´ÑƒĞ±Ğ»Ñ–Ğ²');
  const idxs=[];
  S.dupOrder.forEach(n=>S.groups[n].forEach(ri=>idxs.push(ri)));
  if (idxs.length) dl(toCSV(idxs),'duplicates.csv');
  else logWarn('downloadDuplicates: Ğ½ĞµĞ¼Ğ°Ñ” Ğ´Ğ°Ğ½Ğ¸Ñ…');
}

function downloadWithoutDuplicates() {
  logInfo('Ğ—Ğ°Ğ¿Ğ¸Ñ‚: Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ±ĞµĞ· Ğ´ÑƒĞ±Ğ»Ñ–Ğ²');
  const idxs=S.order.map(n=>S.groups[n][0]);
  if (idxs.length) dl(toCSV(idxs),'without_duplicates.csv');
  else logWarn('downloadWithoutDuplicates: Ğ½ĞµĞ¼Ğ°Ñ” Ğ´Ğ°Ğ½Ğ¸Ñ…');
}

function downloadInvalid() {
  logInfo('Ğ—Ğ°Ğ¿Ğ¸Ñ‚: Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½ĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ñ…');
  if (!S.invalid.length) { logWarn('downloadInvalid: Ğ½ĞµĞ¼Ğ°Ñ” Ğ½ĞµĞ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ñ…'); return; }
  dl(toCSV(S.invalid.map(x=>x.rowIdx)),'invalid_numbers.csv');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE I/O
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function readFile(file) {
  if (!file) { logWarn('readFile: Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ²Ğ¸Ğ±Ñ€Ğ°Ğ½Ğ¾'); return; }
  logInfo('Ğ¤Ğ°Ğ¹Ğ» Ğ²Ğ¸Ğ±Ñ€Ğ°Ğ½Ğ¾', { name: file.name, size: file.size + ' Ğ±Ğ°Ğ¹Ñ‚', type: file.type });
  document.getElementById('file-name').textContent='âœ“ '+file.name;
  const r=new FileReader();
  r.onload=ev=>{
    try {
      document.getElementById('textarea').value=ev.target.result;
      loadText(ev.target.result);
      logOk(`Ğ¤Ğ°Ğ¹Ğ» Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾: ${file.name}`);
    } catch(e) {
      logErr(`ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñƒ: ${file.name}`, e.message);
    }
  };
  r.onerror=()=>logErr('FileReader: Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ', file.name);
  r.readAsText(file,'utf-8');
}

document.getElementById('file-input').addEventListener('change', e=>readFile(e.target.files[0]));

const dz=document.getElementById('dropzone');
dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('drag'); });
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{
  e.preventDefault(); dz.classList.remove('drag');
  logInfo('Drag & Drop: Ñ„Ğ°Ğ¹Ğ» ÑĞºĞ¸Ğ½ÑƒÑ‚Ğ¾');
  readFile(e.dataTransfer.files[0]);
});

document.getElementById('textarea').addEventListener('input',e=>{
  if (e.target.value.trim()) loadText(e.target.value);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function set(id,v) { document.getElementById(id).textContent=v; }

// â”€â”€ Init log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logInfo('Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº Ñ–Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾', {
  ua: navigator.userAgent.slice(0,60),
  time: new Date().toLocaleString('uk-UA'),
  version: '2.0.0'
});
</script>
</body>
</html>
